# AGENTS.md

以下は本プロジェクトにおける恒久的なコーディング規約や開発指針です。Codex や他の AI アシスタントが参照しやすく、マークダウンの書式崩れを防ぐよう配慮しています。

---

## 1. プロジェクト概要

- **プロジェクト名**: Tauri Manga Viewer (仮称)
- **目的**: Tauri v2 を採用し、モバイル対応を視野に入れた漫画ビューワーを開発する
- **主要機能
  - ファイル検索（本棚機能）
  - サムネイル表示
  - 漫画ページの表示

## 2. 基本機能

1. **ファイル検索（本棚）**
   - ローカルディレクトリを走査し、漫画ファイル（例: `.cbz`, `.zip`, 画像フォルダ 等）を一覧表示
   - 検索結果はサムネイルつきでツリー表示またはリスト表示

2. **サムネイル表示**
   - 各漫画フォルダやアーカイブの表紙を抽出してサムネイル化
   - サムネイル生成は非同期かつ並列処理で行うこと
   - キャッシュ機構を実装し、起動時の再生成を最小限に抑える

3. **漫画表示**
   - 1 ページごとにスワイプまたは矢印キーで移動可能
   - ページ遷移アニメーションは軽量なものを選択
   - 画像の縦スクロール／見開き表示モードをサポートする

## 3. 追加機能（基本機能整備後）

- **SMB 接続**
  - ネットワーク上の共有フォルダをマウントせずに直接読み込み
  - 認証情報の入力画面を用意し、接続先ごとにセッション管理

- **FTP 接続**
  - FTP サーバー上のフォルダをリモート本棚として扱う
  - ダウンロードキャッシュをローカルに持たせ、閲覧中のみデータを保持

- **しおり機能**
  - 読み途中のページをユーザーごとに記録
  - 複数タイトルのしおりを一元管理するダッシュボードを用意

## 4. 技術スタック

### 4.1 バックエンド (Rust)

- **言語**: Rust (edition 2021 以上)
- **非同期ランタイム**: `tokio` または `async-std`（プロジェクトで統一する）
- **非同期ファイル I/O**: `tokio::fs` や `async_std::fs` を活用
- **アーカイブ操作**: 可能な限り純 Rust ライブラリを採用
  - 例: `zip`, `image`, `cbz`, `rar` 対応ライブラリなど
  - 新たにライブラリを追加する際は必ず事前にチームへ確認
- **エラー処理**: `anyhow` や `thiserror` を利用し、詳細なエラーメッセージを返す
- **並列処理**: `FuturesUnordered` などを用いたタスク並列化を推奨
- **ビルド成果物**: `target/` 配下に生成。Codex 用に `.codexignore` へ `target/**` を記載

### 4.2 フロントエンド (HTML / CSS / JavaScript)

- **HTML**: セマンティックかつアクセシブルなマークアップを心がける
- **CSS**:
  - モバイルファーストデザイン
  - モジュール化を推奨（ファイルごとに分割）
  - クラス命名は BEM や Tailwind のユーティリティクラスを組み合わせる
- **JavaScript**:
  - 最小限に留め、必要な場合は純粋な ES6+ で実装
  - フレームワークは原則導入しないが、複雑化する場合は Svelte や Vue など軽量なものを相談の上導入可
  - 非同期通信は `fetch` API を使用
- **画像アセット**:
  - `./images/` 配下に配置。ユーザー指定の画像は必ずこのディレクトリに置く
  - 指定された画像が存在しない場合、起動時にユーザーへリクエストを出す

## 5. ライブラリ運用ポリシー

- **純 Rust ライブラリ優先**: C バインディングや外部バイナリを用いない、メンテナンスしやすいライブラリを選定
- **ユーザー指定ライブラリ**: ユーザーが要望したライブラリは原則採用
  - ただし、**致命的な問題**（セキュリティリスクやライセンス不適合など）がある場合は要相談
  - 具体的な問題が発生した際には GitHub Issues を立て、チーム内で合意を取る
- **依存追加時の手順**:
  1. `Cargo.toml` へ仮追加し、`cargo check` / `cargo test` を実行
  2. ベンチマークやテストを通し、ビルドサイズやパフォーマンスに大きな影響がないか確認
  3. 問題なければ PR を作成し、先にコードレビューを受ける

## 6. コーディングガイドライン

### 6.1 Rust コード規約

- **フォーマット**: `rustfmt --edition 2021` で自動整形
- **Lint**: `clippy` を CI で常時実行
- **モジュール構成**:
  - `src-tauri/` 直下にバックエンドコードを配置
  - ゼネリックなライブラリは `src-tauri/lib/` 配下へ
  - テストコードは `tests/` フォルダに分離
- **エラーハンドリング**:
  - `Result<T, E>` を返し、呼び出し元で明示的にハンドリング
  - ログは `tracing` クレートを使用し、開発環境と本番でレベルを切り替え可能にする
- **非同期/並列処理**:
  - I/O ボトルネックが予想される処理は非同期で実装
  - CPU バウンドな処理はスレッドプール（`tokio::task::spawn_blocking` など）で分散

### 6.2 フロントエンドコード規約

- **ファイル構成**:
  - `src/` 配下に `index.html`, `css/`, `js/` を配置
  - 主要な UI コンポーネントは `js/components/` 配下に格納
- **命名規則**:
  - CSS クラスは小文字ハイフン区切り（例: `manga-thumbnail`）
  - JavaScript の変数・関数はキャメルケース（例: `loadMangaList`）
- **可読性**:
  - 1 関数は 50 行以内を目安とし、責務を明確に分割
  - コメントは日本語で具体的に記載
- **レスポンシブ**:
  - メディアクエリは最大幅 / 最小幅を指定してスマホ・タブレット対応を確実に
  - 主要ブレークポイント: 320px (スマホ), 768px (タブレット), 1024px (デスクトップ)

## 7. ビルド & デプロイ

- **開発サーバ起動**:
  ```bash
  # フロントエンド単体確認 (必要に応じて)
  live-server src/   # または任意の静的サーバ

  # Tauri + フロントエンドを同時起動
  cd <プロジェクトルート>
  cargo tauri dev
  ```

- **本番ビルド**:
  ```bash
  cd <プロジェクトルート>
  # フロントエンドビルド (必要に応じて)
  npm run build

  # Tauri アプリのビルド
  cargo tauri build
  ```

- **成果物**:
  - macOS: `src-tauri/target/release/bundle/dmg/` 直下に `.dmg` ファイル
  - Windows: `src-tauri/target/release/bundle/msi/` または `.exe`
  - Linux: `src-tauri/target/release/bundle/deb/` または AppImage

## 8. 画像アセット管理

- **配置場所**: プロジェクトルートの `./images/` フォルダ
- **画像フォーマット**: PNG または WebP 推奨
- **命名規則**: 小文字ハイフン区切り。例: `icon-thumbnail.png`, `loader-spinner.webp`
- **不足時の対応**:
  - コード内で参照したが存在しない場合、Codex や開発者へ新規画像の提供をリクエストする

## 9. ドキュメント & 連携ルール

- **AGENTS.md** は常に最新状態を維持し、AI に読み込ませる
- **新機能または大きな仕様変更**が発生したら、必ず同リポジトリ直下に `spec_<YYYYMMDD>.md` を追加し、Codex に渡す
- **コードレビュー**: PR を作成する際、変更点に関連するテストを必ず同時追加
- **Issues**: バグ or 仕様改善は GitHub Issues で管理し、該当 Issue 番号をコミットメッセージに含める

---

以上が本プロジェクトにおける恒久的なルールです。新しいメンバーや AI にも参照しやすいよう、逐次更新してください。
